# 1. watchdog

简而言之，watchdog是为了保证系统正常运行，或者从死循环，死锁等一场状态退出的一种机制。


## 硬件watchdog

bmc (基板管理控制器) 实现frb 级别1、2和3。如果预设引导处理器(bsp) 无法完成引导过程, frb 将尝试使用备用处理器进行引导。
- frb 级别1旨在从开机自检过程中检测到的bist 故障中恢复。此frb 恢复完全由bios 代码处理。
- frb 级别2旨在在开机自检期间从看门狗超时中恢复。frb 级别2的看门狗计时器在bmc 中实现。
- frb 第3级旨在从硬重定或通电时的看门狗超时中恢复。这将为此级别的frb 提供硬体功能。

### frb-1

在多处理器系统中, bios在多处理器(mp)表和acpi apic表中注册应用程式处理器。当bsp启动时,如果应用程式处理器(ap)无法在一定时间内完成初始化,则假定它无法正常工作。如果bios检测到应用程式处理器出现bist故障或无法正常工作,它将请求bmc禁用该处理器。

然后, bmc在禁用处理器时生成系统重置;bios在下一个启动周期中看不到出现故障的处理器。失败的ap未在mp表中列出,也未在acpi apic表中列出,并且对作业系统不可见。如果bios检测到bist失败,它将向bmc发送一个请求,以禁用当前处理器。如果没有可用的备用处理器, bmc将对扬声器发出蜂鸣声并停止系统。如果bmc可以找到另一个处理器,则bsp拥有权将通过系统重置转移到该处理器。

### frb-2

bmc中的第二个看门狗计时器(frb-2)由bios设置约6分钟,旨在保证系统完成bios开机自检。在禁用frb-3计时器之前启用frb-2计时器,以防止任何不受保护的时间视窗。在开机自检快结束时,在初始化选项rom之前, bios将禁用bmc中的frb-2计时器。

如果系统包含超过1 gb的记忆体,并且使用者选择测试每个dword记忆体,则在扩充记忆体测试开始之前将禁用看门狗计时器,因为在此配置下,记忆体测试可能需要6分钟以上的时间。如果系统在开机自检期间挂起, bios将不会禁用bmc中的计时器,这将生成非同步系统重置(asr)。

### frb-3

每当系统出现硬重定时,第一个计时器(frb-3)就会开始倒计时,这通常是5秒左右。如果bsp成功重置并开始执行, bios将通过取消断言frb _ timer _ hlt信号(gpio)来禁用bmc中的frb-3计时器,系统将继续使用开机自检。如果计时器由于bsp无法获取或执行bios代码而过期, bmc将重置系统并禁用出现故障的处理器。

系统将继续更改bsp,直到bios开机自检通过禁用bmc中的frb-3计时器。如果无法找到合适的处理器, bmc会在扬声器上发出蜂鸣音。在系统重置或电源回圈时重复回圈通过所有处理器的过程。

## 软件watchdog以及softlockup、hardlockup

软件看门狗分为两种，用于检测softlockup的watchdog线程软狗(CPU调度该线程运行来喂狗，基于hrtimer定时器中断来判断是否超过时间阈值），以及检测hard lockup的hrtimer定时器狗（hrtimer定时器溢出中断服务函数来喂狗，基于NMI中断来判断中断计数是否有变化）。

> 注1：时钟中断优先级小于NMI中断。

> 注2：lockup，是指某段内核代码占着CPU不放。Lockup严重的情况下会导致整个系统失去响应。

- soft lockup：是指CPU无法进行线程调度、但仍能够响应中断；
- hard lockup：发生在CPU屏蔽中断的情况下，也就是说CPU已经不能响应中断了。

### softlockup检测机制（soft_watchdog）

标志着单个cpu检测线程已不能正常调度。

可能产生softlock的原因：
- 频繁处理硬中断以至于没有时间正常调度线程
- 长期处理软中断
- 对于非抢占式内核，某个线程长时间执行而不触发调度
- 以上all

### hardlockup检测机制（nmi_watchdog）

单个CPU检测中断是否能够正常上报，当CPU处于关中断状态达到一定时间会被判定进入hard lockup。

可能产生hardlock狗溢出的原因：
- 长期处理某个硬中断
- 长时间在禁用本地中断下处理

NMI检测hrtimer狗机制也是用一个percpu的hrtimer定时器到期事件来喂狗，为了能够及时检测到hard lockup状态，在比hrtimer时钟中断优先级更高的NMI中断上下文进行检测。