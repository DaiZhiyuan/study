[TOC]

# 概述

从中断/异常处理程序中返回，使用IRET指令，在64位模式下应该使用IRETQ指令。返回的过程异常复杂。我们看看这个返回流程。

# 1. 返回时的任务切换

# 2. IRET指令的operand size

## 2.1 IRET指令的助记符

## 2.2 指令operand size的判断及行为

# 3 IRET指令返回前的检查

## 3.1 CS Selector及Code Segment Descriptor类型的检查

## 3.2 CS Selector及Code Segment Descriptor权限的检查

## 3.3 64位模式下的Stack

# 4. 返回到低权限级别时

## 4.1 权限和stack的切换

### 4.1.1 读取SS Selector与ESP值

### 4.1.2 SS Selector及Data Segment Descriptor的类型检查

### 4.1.3 SS Selector及Data Segment Descriptor的权限检查

## 4.2 寄存器的加载

### 4.2.1 CS、EIP与SS、ESP寄存器的加载

### 4.2.2 EFLAGS寄存器的加载

### 4.2.3 更新CPL值

### 4.2.4 更新ES、DS、fS、GS寄存器

# 5. 同级返回

# 6. 错误码

## 6.1 确定descriptor table

## 6.2 external event（外部事件）

## 6.3 Selector Index

## 6.4 #PF（Page Fault）异常的错误码